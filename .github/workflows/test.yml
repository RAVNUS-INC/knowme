name: Daily Scrum Notification

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 10ì‹œì— ì‹¤í–‰ (UTC ê¸°ì¤€ ìƒˆë²½ 1ì‹œ)
    # ë¶„ ì‹œ ì¼ ì›” ìš”ì¼
    - cron: '0 1 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì˜µì…˜ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    # ë¦¬í¬ì§€í† ë¦¬ ê¶Œí•œ ì„¤ì • (ì´ìŠˆ, PR ì½ê¸°)
    permissions:
      issues: read
      pull-requests: read
    steps:
      - name: Checkout repository # ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Fetch Open Issues # ì—´ë ¤ìˆëŠ” ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_list=$(gh issue list --state open --limit 30 --json number,title,url)
          echo "Raw issue list: $issue_list" # ë””ë²„ê¹… ë¡œê·¸
          if [[ "$(echo "$issue_list" | jq '. | length')" -gt 0 ]]; then
            # jq -r ë¡œ ìƒì„±í•˜ë©´ ê° í•­ëª©ì´ ìƒˆ ì¤„ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì´ ë©ë‹ˆë‹¤.
            formatted_issues=$(echo "$issue_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_issues="- ì—´ë ¤ìˆëŠ” ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo "Formatted issues (multiline string for GITHUB_ENV):" # ë””ë²„ê¹… ë¡œê·¸
          echo "$formatted_issues"
          echo "ISSUE_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_issues" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch Open PRs # ì—´ë ¤ìˆëŠ” PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_list=$(gh pr list --state open --limit 30 --json number,title,url)
          echo "Raw PR list: $pr_list" # ë””ë²„ê¹… ë¡œê·¸
          if [[ "$(echo "$pr_list" | jq '. | length')" -gt 0 ]]; then
            # jq -r ë¡œ ìƒì„±í•˜ë©´ ê° í•­ëª©ì´ ìƒˆ ì¤„ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì´ ë©ë‹ˆë‹¤.
            formatted_prs=$(echo "$pr_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_prs="- ì—´ë ¤ìˆëŠ” PRì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo "Formatted PRs (multiline string for GITHUB_ENV):" # ë””ë²„ê¹… ë¡œê·¸
          echo "$formatted_prs"
          echo "PR_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_prs" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Construct Discord Message # Discord ë©”ì‹œì§€ ì¡°í•©
        id: message
        run: |
          TODAY=$(date +'%Y-%m-%d')

          # GITHUB_ENVì—ì„œ ì½ì–´ì˜¨ ISSUE_LISTì™€ PR_LISTëŠ” ì—¬ëŸ¬ ì¤„ ë¬¸ìì—´ì…ë‹ˆë‹¤.
          # ì´ ë‚´ë¶€ì˜ ì‹¤ì œ ê°œí–‰ ë¬¸ì(newline)ë¥¼ ë¦¬í„°ëŸ´ '\\n'ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          # Bashì˜ ë§¤ê°œë³€ìˆ˜ í™•ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤: ${parameter//pattern/string}
          # $'\n'ì€ ì‹¤ì œ ê°œí–‰ ë¬¸ìë¥¼ ì˜ë¯¸í•˜ë©°, '\\n'ì€ ë¦¬í„°ëŸ´ ë°±ìŠ¬ë˜ì‹œì™€ nì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
          issues_escaped_for_json="${ISSUE_LIST//$'\n'/\\n}"
          prs_escaped_for_json="${PR_LIST//$'\n'/\\n}"

          # MESSAGE ë¬¸ìì—´ì„ êµ¬ì„±í•  ë•Œ, ì¤„ë°”ê¿ˆì´ í•„ìš”í•œ ê³³ì— ë¦¬í„°ëŸ´ '\\n'ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ì´ë ‡ê²Œ í•´ì•¼ MESSAGE ë³€ìˆ˜ ìì²´ê°€ ë‹¨ì¼ ë¼ì¸ ë¬¸ìì—´ì´ ë˜ê³ , jqê°€ ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          MESSAGE="## â˜€ï¸ ${TODAY} ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì•ˆë‚´ â˜€ï¸\\n\\n"
          MESSAGE+="**â° ì˜¤ëŠ˜ ì˜¤ì „ ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì‹œê°„ì…ë‹ˆë‹¤!**\\n\\n"
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” ì´ìŠˆ:**\\n${issues_escaped_for_json}\\n\\n"
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” Pull Requests:**\\n${prs_escaped_for_json}\\n\\n"
          MESSAGE+="ì ì‹œ í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³  ê°ì ì§„í–‰ ìƒí™©ê³¼ ì´ìŠˆë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”! ğŸ˜Š"
          
          echo "Constructed Message String (with literal \\\\n for jq):"
          echo "${MESSAGE}" # ì´ ë¡œê·¸ì—ì„œëŠ” \\nì´ ë¬¸ì ê·¸ëŒ€ë¡œ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤.
          echo "---------------------------------"

          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON í˜ì´ë¡œë“œ ìƒì„±
          # --arg ì˜µì…˜ìœ¼ë¡œ ì „ë‹¬ëœ ë¬¸ìì—´ ë‚´ì˜ '\\n'ì€ jqì— ì˜í•´ JSON ë¬¸ìì—´ ë‚´ì˜ ì‹¤ì œ ì´ìŠ¤ì¼€ì´í”„ëœ '\n'ìœ¼ë¡œ ì˜¬ë°”ë¥´ê²Œ ì¸ì½”ë”©ë©ë‹ˆë‹¤.
          JSON_PAYLOAD=$(jq -nc --arg content "${MESSAGE}" '{"content": $content}')
          
          # JSON í˜ì´ë¡œë“œê°€ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ (JSON ë¬¸ìì—´ ë‚´ì— \nì´ í¬í•¨ë˜ì–´ì•¼ í•¨)
          printf "Generated JSON_PAYLOAD (this should contain actual \\n for newlines in JSON string):\n%s\n" "${JSON_PAYLOAD}"
          echo "---------------------------------"
          
          # GITHUB_ENVì—ëŠ” ì´ë¯¸ ì˜¬ë°”ë¥¸ JSON ë¬¸ìì—´ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
          echo "JSON_PAYLOAD=${JSON_PAYLOAD}" >> $GITHUB_ENV

      - name: Send Notification to Discord # Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # JSON_PAYLOADëŠ” ì´ì „ ìŠ¤í…ì—ì„œ GITHUB_ENVë¥¼ í†µí•´ ì „ë‹¬ë°›ìŒ
        run: |
          echo "Attempting to send notification to Discord."
          echo "Using Webhook URL (first 30 chars): $(echo $DISCORD_WEBHOOK_URL | cut -c 1-30)..." # URL ì¼ë¶€ë§Œ ì¶œë ¥ (ë³´ì•ˆ)
          
          # GITHUB_ENVì—ì„œ JSON_PAYLOADë¥¼ ì½ì–´ì˜´ (ì´ ìŠ¤í…ì—ì„œ ì§ì ‘ ì ‘ê·¼ ì‹œ)
          # ë§Œì•½ ì´ì „ ìŠ¤í…ì—ì„œ ì„¤ì •ëœ GITHUB_ENVë¥¼ ë°”ë¡œ ì‚¬ìš©í•œë‹¤ë©´ ì´ ì¤„ì€ í•„ìš” ì—†ìŒ.
          # current_payload="${JSON_PAYLOAD_FROM_ENV}" # ì˜ˆì‹œ, ì‹¤ì œë¡œëŠ” ë°”ë¡œ $JSON_PAYLOAD ì‚¬ìš©
          
          echo "Payload being sent (from GITHUB_ENV):"
          printf "%s\n" "$JSON_PAYLOAD" # $JSON_PAYLOAD ë³€ìˆ˜ëŠ” ì‰˜ì— ì˜í•´ ì´ì „ ìŠ¤í…ì˜ GITHUB_ENVì—ì„œ í™•ì¥ë¨
          
          # curl ëª…ë ¹ì–´ ì‹¤í–‰ ë° ê²°ê³¼ ì¶œë ¥ (ì˜¤ë¥˜ í™•ì¸ ìš©ì´)
          # -d ì˜µì…˜ì— ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” í°ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ë³€ìˆ˜ í™•ì¥ì´ ì¼ì–´ë‚˜ë„ë¡ í•©ë‹ˆë‹¤.
          curl_response_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          "${DISCORD_WEBHOOK_URL}")
          
          echo "Discord API Response Code: $curl_response_code"
          
          if [[ "$curl_response_code" -ge 200 && "$curl_response_code" -lt 300 ]]; then
            echo "Notification sent successfully!"
          else
            echo "Error sending notification. Response code: $curl_response_code"
            # ì „ì²´ ì‘ë‹µì„ ë³´ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒì„ í™œì„±í™”
            # curl -i -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "${DISCORD_WEBHOOK_URL}"
            exit 1 # ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
          fi
