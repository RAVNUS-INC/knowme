name: Daily Scrum Notification

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 10ì‹œì— ì‹¤í–‰ (UTC ê¸°ì¤€ ìƒˆë²½ 1ì‹œ)
    # ë¶„ ì‹œ ì¼ ì›” ìš”ì¼
    - cron: '0 1 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì˜µì…˜ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    # ë¦¬í¬ì§€í† ë¦¬ ê¶Œí•œ ì„¤ì • (ì´ìŠˆ, PR ì½ê¸°)
    permissions:
      issues: read
      pull-requests: read
    steps:
      - name: Checkout repository # ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Fetch Open Issues # ì—´ë ¤ìˆëŠ” ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_list=$(gh issue list --state open --limit 30 --json number,title,url)
          echo "Raw issue list: $issue_list" # ë””ë²„ê¹… ë¡œê·¸
          if [[ "$(echo "$issue_list" | jq '. | length')" -gt 0 ]]; then
            formatted_issues=$(echo "$issue_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_issues="- ì—´ë ¤ìˆëŠ” ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo "Formatted issues: $formatted_issues" # ë””ë²„ê¹… ë¡œê·¸
          echo "ISSUE_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_issues" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch Open PRs # ì—´ë ¤ìˆëŠ” PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_list=$(gh pr list --state open --limit 30 --json number,title,url)
          echo "Raw PR list: $pr_list" # ë””ë²„ê¹… ë¡œê·¸
          if [[ "$(echo "$pr_list" | jq '. | length')" -gt 0 ]]; then
            formatted_prs=$(echo "$pr_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_prs="- ì—´ë ¤ìˆëŠ” PRì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo "Formatted PRs: $formatted_prs" # ë””ë²„ê¹… ë¡œê·¸
          echo "PR_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_prs" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Construct Discord Message # Discord ë©”ì‹œì§€ ì¡°í•©
        id: message
        run: |
          TODAY=$(date +'%Y-%m-%d')
          MESSAGE="## â˜€ï¸ ${TODAY} ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì•ˆë‚´ â˜€ï¸\n\n"
          MESSAGE+="**â° ì˜¤ëŠ˜ ì˜¤ì „ ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì‹œê°„ì…ë‹ˆë‹¤!**\n\n"
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” ì´ìŠˆ:**\n$ISSUE_LIST\n\n" # $ISSUE_LIST ì•ë’¤ ê³µë°± ì œê±° ê°€ëŠ¥ì„± ê³ ë ¤
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” Pull Requests:**\n$PR_LIST\n\n" # $PR_LIST ì•ë’¤ ê³µë°± ì œê±° ê°€ëŠ¥ì„± ê³ ë ¤
          MESSAGE+="ì ì‹œ í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³  ê°ì ì§„í–‰ ìƒí™©ê³¼ ì´ìŠˆë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”! ğŸ˜Š"
          echo "Constructed Message Content: $MESSAGE" # ë””ë²„ê¹… ë¡œê·¸
          
          JSON_PAYLOAD=$(jq -nc --arg content "$MESSAGE" '{"content": $content}')
          echo "Generated JSON_PAYLOAD: $JSON_PAYLOAD" # ë””ë²„ê¹… ë¡œê·¸
          echo "JSON_PAYLOAD=$JSON_PAYLOAD" >> $GITHUB_ENV

      - name: Send Notification to Discord # Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "Attempting to send notification to Discord."
          echo "Using Webhook URL (first 30 chars): $(echo $DISCORD_WEBHOOK_URL | cut -c 1-30)..." # URL ì¼ë¶€ë§Œ ì¶œë ¥ (ë³´ì•ˆ)
          echo "Payload being sent: $JSON_PAYLOAD" # ë””ë²„ê¹… ë¡œê·¸
          
          # curl ëª…ë ¹ì–´ ì‹¤í–‰ ë° ê²°ê³¼ ì¶œë ¥ (ì˜¤ë¥˜ í™•ì¸ ìš©ì´)
          curl_response_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          "${DISCORD_WEBHOOK_URL}")
          
          echo "Discord API Response Code: $curl_response_code"
          
          if [[ "$curl_response_code" -ge 200 && "$curl_response_code" -lt 300 ]]; then
            echo "Notification sent successfully!"
          else
            echo "Error sending notification. Response code: $curl_response_code"
            # ìƒì„¸ ì˜¤ë¥˜ë¥¼ ë³´ê³  ì‹¶ë‹¤ë©´ -v ì˜µì…˜ì„ ì¶”ê°€í•˜ê±°ë‚˜, -o output.txt ë¡œ ì‘ë‹µ ë³¸ë¬¸ì„ íŒŒì¼ì— ì €ì¥í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            # ì˜ˆ: curl -v -X POST ...
            exit 1 # ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
          fi
