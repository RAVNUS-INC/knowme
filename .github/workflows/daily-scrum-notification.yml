name: Daily Scrum Notification

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 10ì‹œì— ì‹¤í–‰ (UTC ê¸°ì¤€ ìƒˆë²½ 1ì‹œ)
    # ë¶„ ì‹œ ì¼ ì›” ìš”ì¼
    - cron: '0 1 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì˜µì…˜ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    # ë¦¬í¬ì§€í† ë¦¬ ê¶Œí•œ ì„¤ì • (ì´ìŠˆ, PR ì½ê¸°)
    permissions:
      issues: read
      pull-requests: read
    steps:
      - name: Checkout repository # ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Get GitHub Token for gh CLI # GitHub CLI ì‚¬ìš©ì„ ìœ„í•œ í† í° ì„¤ì •
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # gh CLI ì„¤ì¹˜
          sudo apt-get install gh jq -y
          # GitHub CLI ì¸ì¦ (í† í° ì‚¬ìš©)
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Fetch Open Issues # ì—´ë ¤ìˆëŠ” ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: issues
        run: |
          # gh clië¥¼ ì‚¬ìš©í•˜ì—¬ json í˜•íƒœë¡œ ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          issue_list=$(gh issue list --state open --limit 30 --json number,title,url)
          # ê²°ê³¼ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í¬ë§·íŒ…, ë¹„ì–´ìˆìœ¼ë©´ "ì—†ìŒ" ë©”ì‹œì§€ ì„¤ì •
          if [[ "$(echo "$issue_list" | jq '. | length')" -gt 0 ]]; then
            formatted_issues=$(echo "$issue_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_issues="- ì—´ë ¤ìˆëŠ” ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
          # ë©€í‹°ë¼ì¸ ë¬¸ìì—´ì„ ìœ„í•´ EOF ì‚¬ìš© ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "ISSUE_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_issues" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch Open PRs # ì—´ë ¤ìˆëŠ” PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 30ê°œ)
        id: prs
        run: |
          # gh clië¥¼ ì‚¬ìš©í•˜ì—¬ json í˜•íƒœë¡œ PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          pr_list=$(gh pr list --state open --limit 30 --json number,title,url)
          # ê²°ê³¼ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í¬ë§·íŒ…, ë¹„ì–´ìˆìœ¼ë©´ "ì—†ìŒ" ë©”ì‹œì§€ ì„¤ì •
          if [[ "$(echo "$pr_list" | jq '. | length')" -gt 0 ]]; then
            formatted_prs=$(echo "$pr_list" | jq -r '.[] | "- (#\(.number)) \(.title) - <\(.url)>"')
          else
            formatted_prs="- ì—´ë ¤ìˆëŠ” PRì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          # ë©€í‹°ë¼ì¸ ë¬¸ìì—´ì„ ìœ„í•´ EOF ì‚¬ìš© ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "PR_LIST<<EOF" >> $GITHUB_ENV
          echo "$formatted_prs" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Construct Discord Message # Discord ë©”ì‹œì§€ ì¡°í•©
        id: message
        run: |
          # ë‚ ì§œ í¬ë§· (YYYY-MM-DD)
          TODAY=$(date +'%Y-%m-%d')
          # ìµœì¢… ë©”ì‹œì§€ ì¡°í•© (Markdown í˜•ì‹ í™œìš©)
          MESSAGE="## â˜€ï¸ ${TODAY} ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì•ˆë‚´ â˜€ï¸\n\n"
          MESSAGE+="**â° ì˜¤ëŠ˜ ì˜¤ì „ ë°ì¼ë¦¬ ìŠ¤í¬ëŸ¼ ì‹œê°„ì…ë‹ˆë‹¤!**\n\n"
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” ì´ìŠˆ:**\n $ISSUE_LIST \n\n"
          MESSAGE+="**í˜„ì¬ ì—´ë ¤ìˆëŠ” Pull Requests:**\n $PR_LIST \n\n"
          MESSAGE+="ì ì‹œ í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³  ê°ì ì§„í–‰ ìƒí™©ê³¼ ì´ìŠˆë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”! ğŸ˜Š"
          # Discord ì›¹í›… í˜ì´ë¡œë“œ í˜•ì‹ì— ë§ê²Œ JSON ìƒì„± ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          # JSON ë¬¸ìì—´ ë‚´ íŠ¹ìˆ˜ë¬¸ì(ë”°ì˜´í‘œ, ê°œí–‰ ë“±) ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í•„ìš”
          JSON_PAYLOAD=$(jq -nc --arg content "$MESSAGE" '{"content": $content}')
          echo "JSON_PAYLOAD=$JSON_PAYLOAD" >> $GITHUB_ENV

      - name: Send Notification to Discord # Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }} # GitHub Secretsì—ì„œ ì›¹í›… URL ê°€ì ¸ì˜¤ê¸°
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '$JSON_PAYLOAD' \
          "${DISCORD_WEBHOOK_URL}"
